#!/usr/bin/env zsh

local persistent="<%= @persistent_directory %>"

IFS=$'\0'
export PATH="/usr/local/bin:/usr/local/sbin:/usr/bin:/usr/sbin:/bin:/sbin"
export SHELL="/bin/zsh"
export HOME="/"

local homedir=~"$(whoami)"
if [[ ! -e "$homedir" ]]; then
    exit 1
fi

local lockdir="$homedir/.batch"
if [[ ! -e "$lockdir" ]]; then
  mkdir -p "$lockdir"
fi

function seconds() {
  date +'%s'
}

for file in $(find "$persistent" -type f -iname '*.seconds' -print0); do
  if [[ -z "$file" ]]; then
    continue
  fi

  local period="$(echo "$file" | egrep -o '[^/]+$' | egrep -o '^[^.]+')"
  local timestamp="$persistent/$period.timestamp"

  if [[ ! -f "$timestamp" ]]; then
    echo 0 > "$timestamp"
  fi

  local last="$(cat "$timestamp")"
  local span="$(cat "$file")"
  local current="$(seconds)"

  if (( current - span < last )); then
    continue
  fi

  for batch in $(find "/etc/batch.${period}" -type f -executable -print0); do

    if [[ -z "$batch" ]]; then
      continue
    fi

    "<%= @batch %>" "$batch" > /dev/null 2>&1 &
  done

  for batch in $(find "/etc/batch.${period}.once" -type f -executable -print0); do

    if [[ -z "$batch" ]]; then
      continue
    fi
   
    local lock="$lockdir/$(basename "$batch").lock"

    if [[ -f "$lock" ]]; then
      continue
    fi
    touch "$lock"

    "<%= @batch %>" "<%= @run_and_remove_lock %>" "$lock" "$batch" > /dev/null 2>&1 &
  done

  seconds > "$timestamp"
done
