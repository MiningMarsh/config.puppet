#!/usr/bin/env zsh
. <%= @stdlib %>

std/root

std/lock portage

NOW=$(date "+%s")
TIMESTAMP="<%= @update_portage_timestamp %>"
if [[ ! -f "$TIMESTAMP" ]]; then
	echo "$NOW" > "$TIMESTAMP"
fi
if [[ ! -S "$TIMESTMAP" ]]; then
	echo "$NOW" > "$TIMESTAMP"
fi
LAST=$(cat "$TIMESTAMP")

if ((((( $NOW - $LAST ) / 60 ) / 60 ) > 24 )); then
	# Sync.
	/usr/bin/emerge --sync && /usr/bin/layman -S && /usr/bin/eix-update
	if [[ $? -eq 0 ]]; then
		echo "$NOW" > "$TIMESTAMP"
	fi
fi

local function update() {
	/usr/bin/emerge --update --deep --with-bdeps=y --newuse --oneshot $@
}

# Update portage first, to make sure we support all EAPI versions.
update portage || true

# Update everything.
update @world || true
smart-live-rebuild || true

# Try to fix any missing packages or such.
/usr/bin/emerge --oneshot --update @unavailable || true
/usr/bin/emerge --oneshot @preserved-rebuild || true
/usr/bin/revdep-rebuild || true

# Clean.
/usr/bin/emerge --depclean || true
/usr/bin/eclean -d distfiles -f || true
/usr/bin/eclean -d packages || true

# Update dotfiles.
<%= @update_keywords %>
<%= @update_accept_keywords %>-cvs
<%= @update_accept_keywords %>-unstable
<%= @update_use %>
